# Detailed guide

> Come and use it~

## Node development

There are three leaf node types in ice, corresponding to three business abstractions

- *Flow is used for abstractions that can control business flow, such as various judgments or filter conditions, with clear true and false returns
- *Result is used for the abstraction of some results, such as issuing various rewards, there are relatively clear true and false returns (for example, in the reward distribution, it should return true if it is issued, and it should return false if it is not issued)
- *None is used for the abstraction of some unrelated business flows, such as query information, no return value

In the node development process, you can select the abstract leaf node you need to inherit and implement the corresponding method.
- BaseLeaf* uses IceContext as method parameter, need to implement do* method
- BaseLeafPack* uses IcePack as method input, need to implement doPack* method
- BaseLeafRoam* uses IceRoam as method input, need to implement doRoam* method

**eg:**
````java
/**
 * Issue balance node
 */
@Data
@EqualsAndHashCode(callSuper = true)
public class AmountResult extends BaseLeafRoamResult { //The uid that needs to be issued is obtained from roam, so you can inherit BaseLeafRoamResult

    @Resource
    private SendService sendService; //If it is a spring application, you can use springbean directly. For non-Spring applications, please initialize the IceBeanFactory of IceBeanUtils to assemble the instances you need

    private String key; //Configurable uidKey

    private double value; //The configurable balance value value

    @Override
    protected boolean doRoamResult(IceRoam roam) { //You need to implement doRoamResult (that is, your own business content)
        Integer uid = roam.getMulti(key); //Get the uid of the user who needs to issue the balance from roam
        if (uid == null || value <= 0) {
            return false;
        }
        boolean res = sendService.sendAmount(uid, value); //Call the third-party interface to issue the balance (send the balance of value to uid)
        roam.put("SEND_AMOUNT", res); //In the business, I want to put the release result back into roam, maybe for subsequent use
        return res; //return the release result
    }
}
````

## Execute Ice

### Assemble IcePack

pack is the package that needs to be assembled before executing ice

- **iceId** is the ID of the rule to be triggered, corresponding to the ID of the configuration background, iceId can only trigger one configured rule
- **scene** The scene that needs to be triggered, all the rules subscribed to the scene will be triggered
- **confId** trigger rule with any node ID as root
- **requestTime** request time, default System.currentTimeMillis()
- **roam** put the parameters and other information required to execute the rule
- **traceId** link ID, automatically generated by default
- **debug** log printing, refer to DebugEnum The final debug executed is handler.debug|pack.debug

### Call the Ice method

- void syncProcess(IcePack pack) is executed synchronously
- List\<Future\<IceContext\>\> asyncProcess(IcePack pack) executes asynchronously and returns futures

In the business, information such as execution results may be added to the roam, and the desired data can be obtained from the roam after the execution is completed.

## IceRoam

Roam provides the data source required for node execution or stores execution results for subsequent execution. Roam is an extension of ConcurrentHashMap.

- put/get rewrites the put/get of ConcurrentHashMap, ignoring the key/value null pointer exception of ConcurrentHashMap
- putValue/getValue ignores the type matching check, saving the forced conversion operation, pay attention to whether the type matches when using
- putMulti/getMulti use "." to separate and build a hierarchical data structure
- getUnion If the parameter is a string starting with "@", it will go to the roam to get the data and return it, otherwise it will return the parameter itself

```java
roam.putValue("a", 1); //{"a":1}
roam.getValue("a"); //1
roam.putMulti("b.c", 2); //{"a":1,"b":{"c":2}}
roam.putMulti("b.d", 3); //{"a":1,"b":{"c":2,"d":3}}
roam.getMutli("b"); //{"c":2,"d":3}
roam.getMutli("b.c"); //2
roam.getUnion("a"); //"a"
roam.getUnion("@a"); //1
roam.getUnion(1); //1
roam.put("e", "@a");
roam.getUnion("@e");//1
roam.put("e", "a");
roam.getUnion("@e");//"a"
```


















